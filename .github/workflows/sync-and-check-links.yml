name: ðŸ”„ Sync Fork & Check Links & Save Reports

on:
  schedule:
    - cron: '0 3 * * 1'   # Every Monday at 03:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  sync-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "N-Kannan"
          git config user.email "iamnkannan@gmail.com"

      - name: Add upstream remote & sync fork
        run: |
          git remote add upstream https://github.com/MicrosoftDocs/PowerShell-Docs.git || true
          git fetch upstream --prune
          git checkout main
          if git merge --ff-only upstream/main; then
            echo "Fast-forwarded to upstream/main"
            git push origin HEAD:main || echo "Push skipped or failed (check permissions)"
          else
            echo "No fast-forward merge available. Continuing with current branch."
          fi

      - name: Ensure reports directory exists
        run: mkdir -p reports

      - name: Run Lychee - Broken Links Only
        uses: lycheeverse/lychee-action@v2
        id: lychee-broken
        continue-on-error: true
        with:
          args: --verbose --no-progress './**/*.md'
          output: reports/lychee-broken-report.txt
          format: markdown
          fail: 'true'
          failifempty: 'true'
          jobsummary: 'true'
          checkbox: 'true'

      - name: Run Lychee - Redirects as Errors
        uses: lycheeverse/lychee-action@v2
        id: lychee-redirects
        continue-on-error: true
        with:
          args: --verbose --max-redirects 0 --no-progress './**/*.md'
          output: reports/lychee-redirect-report.txt
          format: markdown
          fail: 'true'
          failifempty: 'true'
          jobsummary: 'true'
          checkbox: 'true'

      - name: Ensure report files exist
        run: |
          for f in reports/lychee-broken-report.txt reports/lychee-redirect-report.txt; do
            if [ ! -f "$f" ]; then
              echo "No issues found." > "$f"
            fi
          done

      - name: Convert reports to CSV (code,url,message,source)
        run: |
          set -euo pipefail
          OUT=reports/lychee-issues.csv
          echo '"code","url","message","source"' > "$OUT"

          # helper function: parse a report file
          parse_file() {
            local file="$1"
            local source_label="$2"
            # Find lines starting with '* ' (lychee report failure lines), normalize CRLF, then parse
            grep -E '^\* ' "$file" || true
            grep -E '^\* ' "$file" \
              | sed 's/^\* //' \
              | while IFS= read -r line; do
                  # split into left (code+url) and right (message) on ' | '
                  left="$(printf '%s' "$line" | awk -F' \\| ' '{print $1}')"
                  right="$(printf '%s' "$line" | awk -F' \\| ' '{ if (NF>1) { $1=""; sub(/^ /,"",$0); print substr($0,2)} else print "" }')"

                  code=""
                  url=""

                  # match patterns: [CODE] <URL>
                  if printf '%s' "$left" | grep -qE '^\[[^]]+\] <[^>]+>$'; then
                    code="$(printf '%s' "$left" | sed -E 's/^\[([^]]+)\].*$/\1/')"
                    url="$(printf '%s' "$left" | sed -E 's/^\[[^]]+\] <([^>]+)>.*/\1/')"
                  # fallback: if it's just <URL>
                  elif printf '%s' "$left" | grep -qE '^<[^>]+>$'; then
                    code=""
                    url="$(printf '%s' "$left" | sed -E 's/^<([^>]+)>$/\1/')"
                  else
                    # no angle brackets; treat left as URL or path
                    url="$left"
                  fi

                  # normalize file:// URIs to readable path
                  url="$(printf '%s' "$url" | sed -E 's%^file:/+%%')"

                  # Escape double quotes for CSV
                  esc_code="$(printf '%s' "$code" | sed 's/"/""/g')"
                  esc_url="$(printf '%s' "$url" | sed 's/"/""/g')"
                  esc_msg="$(printf '%s' "$right" | sed 's/"/""/g')"

                  # write CSV row
                  printf '"%s","%s","%s","%s"\n' "$esc_code" "$esc_url" "$esc_msg" "$source_label" >> "$OUT"
                done
          }

          # Parse broken report
          parse_file "reports/lychee-broken-report.txt" "broken"
          # Parse redirect report
          parse_file "reports/lychee-redirect-report.txt" "redirect"

          # If CSV only has header, add an INFO row
          if [ "$(wc -l < "$OUT")" -eq 1 ]; then
            echo '"INFO","No failures detected","No lychee failure lines were found in the reports.","info"' >> "$OUT"
          fi

      - name: Append signature to reports
        run: |
          for f in reports/*.txt; do
            echo -e "\n---\n\nðŸ™ **Thanks,**\n\n**Kannan.N**\nSr Trainer\n[https://www.linkedin.com/in/iamnkannan](https://www.linkedin.com/in/iamnkannan)" >> "$f"
          done
          # For CSV, add comments at the end
          if [ -f reports/lychee-issues.csv ]; then
            echo "" >> reports/lychee-issues.csv
            echo "# ---" >> reports/lychee-issues.csv
            echo "# Thanks, Kannan.N (Sr Trainer) - https://www.linkedin.com/in/iamnkannan" >> reports/lychee-issues.csv
          fi

      - name: Upload reports as artifact (text + csv)
        uses: actions/upload-artifact@v4
        with:
          name: link-check-reports
          path: |
            reports/lychee-broken-report.txt
            reports/lychee-redirect-report.txt
            reports/lychee-issues.csv
